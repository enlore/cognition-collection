<blueprint>
    <data name="canon" />
    <data name="working" />

    <!--<data name="svc" service="data serviceConfig" prop="true" />-->

    <adapter name="serviceConfig" />
    <!--<adapter name="working"  control="true" />-->
    <!--<adapter name="canonical" control="true" />-->

    <!--<sensor needs="collectionConfig,serviceConfig" filter="fetchOnInit" run="fetch" />-->

</blueprint>

<script>
    $.cog({
        init: function init () {
            // there's a initializer that fetches everything off an endpoint
            // there's a Create analog that posts to an endpoint
            // Update puts
            // Delete deletes

        },

        fetch: function fetch () {
            this.svc.request()
        },

        fetchOnInit: function (args) {
            return args.collectionConfig.fetchOnInit ? true : false // filters for undefined
        },

        cid: 1, // internal id counter

        setCid: function (candidate) {
            candidate.cid = this.cid++
            return candidate
        },

        insert: function (candidate, collection, push) {
            candidate = this.setCid(candidate)

            if (collection === void 0)
                var collection = []

            if (push)
                collection.push(candidate)
            else
                collection.unshift(candidate)

            return collection
        },

        updateOne: function (candidate, collection) {
            for (var i = 0; i < collection.length; i++) {
                var member = collection[i]

                if (member.cid === candidate.cid)
                    collection[i] = candidate
            }

            return collection
        },

        find: function (query, collection) {},

        remove: function (candidate, collection) {
            var filtered = collection.filter(function (member) {
                if (member.cid === candidate.cid)
                    return false
                return true
            })

            return filtered
        },

        upsert: function (candidate, collection, push) { // granted, this assumes all ids are unique
            var found = false

            for (var i = 0; i < collection.length; i++) {
                var member = collection[i]

                if (member.cid === candidate.cid) {
                    found = true
                    collection[i] = candidate // found the member in question, so we overwrite
                    break
                }
            }

            if (!found) {
                candidate = this.setCid(candidate)

                if (push)
                    collection.push(candidate)
                else
                    collection.unshift(candidate)
            }

            return collection
        }
    })
</script>
